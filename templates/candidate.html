<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interview Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7f9fc; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 600px; margin-top: 80px; }
    .card { padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    #countdown { font-size: 1.25rem; font-weight: 600; color: #0d6efd; }
    #tooEarly { color: #dc3545; font-weight: 500; }
    .btn-custom { width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card text-center">
      <h3 class="mb-3">Candidate Interview Setup</h3>
      <p class="text-muted">Email: <b>{{ email }}</b></p>
      <p class="text-muted">Interview scheduled at: <b>{{ interview_time }}</b></p>

      <!-- Countdown -->
      <p id="tooEarly" style="display:none;">⏳ Please return within 30 minutes of your interview.</p>
      <p id="countdown"></p>

      <!-- Consent -->
      <div id="consentDiv" style="display:none;">
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="consentChk">
          <label class="form-check-label" for="consentChk">
            I agree to monitoring during the interview
          </label>
        </div>
        <button class="btn btn-primary btn-custom" id="downloadBtn" disabled>
          Download Monitoring Tool
        </button>
      </div>
    </div>
  </div>

  <script>
  const rawTime = "{{ interview_time }}"; // e.g. "2025-09-26_12-00"
  const email = "{{ email }}";

  // Convert "2025-09-26_12-00" → Date object
  function parseInterviewTime(str) {
    // Split into parts
    const [datePart, hm] = str.split("_");  // ["2025-09-26", "12-00"]
    const [year, month, day] = datePart.split("-");
    const [hour, minute] = hm.split("-");
    return new Date(
      parseInt(year),
      parseInt(month) - 1, // JS months are 0-indexed
      parseInt(day),
      parseInt(hour),
      parseInt(minute),
      0
    );
  }

  const interviewTime = parseInterviewTime(rawTime);

  function updateCountdown() {
    const now = new Date();
    const diffMs = interviewTime - now;
    const diffMinutes = diffMs / 60000;

    const countdownEl = document.getElementById("countdown");
    const consentDiv = document.getElementById("consentDiv");
    const tooEarly = document.getElementById("tooEarly");

    if (diffMinutes > 30) {
      // Too early
      tooEarly.style.display = "block";
      countdownEl.innerHTML = `⏳ Interview starts in <b>${Math.floor(diffMinutes)} minutes</b>. Please open this link only 30 minutes before.`;
      consentDiv.style.display = "none";
    } else if (diffMinutes > 0) {
      // Within 30 minutes window
      tooEarly.style.display = "none";
      consentDiv.style.display = "block";
      const mins = Math.floor(diffMinutes);
      const secs = Math.floor((diffMs % 60000) / 1000);
      countdownEl.innerHTML = `Interview starts in <b>${mins}m ${secs}s</b>`;
    } else {
      // Interview time reached or passed
      tooEarly.style.display = "none";
      consentDiv.style.display = "block";
      countdownEl.innerHTML = "✅ Your interview time has arrived!";
    }
  }

  setInterval(updateCountdown, 1000);
  window.onload = updateCountdown;

  // Consent handling
  document.getElementById("consentChk").addEventListener("change", function() {
    document.getElementById("downloadBtn").disabled = !this.checked;
  });

  // Download handler (email + timestamp exactly as in URL)
  document.getElementById("downloadBtn").addEventListener("click", function() {
    const args = email + " " + rawTime;
    window.location.href = "{{ exe_link }}&args=" + encodeURIComponent(args);
  });
</script>
</body>
</html>
